name: Terraform CI

on:
  push:
    branches: [ main1] # update to 'main' while testing
  pull_request:

permissions:
  contents: write  # required for auto-commit/push

jobs:
  sca:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true  # so GITHUB_TOKEN works for push

      - name: Run TFLint (example)
        run: |
          mkdir -p input
          tflint --format json > input/tflint.json || true

      - name: AIOps SCA Agent
        uses: aiops-sca/aiops-sca@v1
        with:
          enable: true
          scope: '["infra/**/*.tf"]'
          input_dir: "./input"
          output_dir: "./output"
          llm_provider: "azure_openai"
          llm_model: "gpt-4o-mini"   # Azure deployment name
          show_recommendation: true
          auto_apply: true
          lint_format: "auto"
          apply_mode: "commit"       # or "pr" or "dry-run"
          max_lines_changed: "200"
          max_files_changed: "10"
          protected_paths: '["infra/modules/vendor/**"]'
          recommendation_format: "markdown"
          fail_on_unfixed: "false"
          commit_message_prefix: "[aiops-sca]"
          git_user_name: "aiops-sca[bot]"
          git_user_email: "aiops-sca-bot@example.com"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_API_VERSION: "2024-06-01"
